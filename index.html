<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Yeastar WebRTC + OSM Caller Location</title>
</head>
<body>

<h2>Yeastar WebRTC Call + Location</h2>

<!-- Yeastar WebRTC placeholder -->
<div id="yeastar-webtrunk"></div>

<!-- Yeastar WebRTC script -->
<script src="https://microbizone.sgycm.yeastarcloud.com/webtrunk/webtrunk_template.js?code=aXpWdkZDUG93UU1wdmxOY2RSOERORDdUdUZzRTFHQ0c="></script>

<script>
let callerLocation = null;
let locationReady = false;

// 1️⃣ Capture GPS on page load
if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position){
        callerLocation = {
            latitude: position.coords.latitude,
            longitude: position.coords.longitude
        };
        locationReady = true;
        console.log("Location captured:", callerLocation);
    }, function(err){
        console.warn("Location not available:", err.message);
    }, { enableHighAccuracy:true, timeout:15000 });
} else {
    console.warn("Geolocation not supported by browser");
}

// 2️⃣ Open GitHub OSM map popup with real coordinates
function openOSMMap() {
    if(callerLocation){
        const popupUrl = `https://99joyboy11.github.io/map2.html?lat=${callerLocation.latitude}&lng=${callerLocation.longitude}`;
        window.open(popupUrl, "_blank", "width=900,height=700,scrollbars=yes");
    } else {
        console.warn("Location not ready");
        // Optional: open map anyway without coordinates
        const popupUrl = `https://99joyboy11.github.io/map2.html`;
        window.open(popupUrl, "_blank", "width=900,height=700,scrollbars=yes");
    }
}

// 3️⃣ Listen for Yeastar call answered event
window.addEventListener("message", function(event) {
    if(event.data && event.data.type === "webrtc-call-status" && event.data.status === "answered"){
        console.log("Call answered");

        // Wait max 10 seconds for GPS to be ready
        let waitTime = 0;
        const interval = setInterval(function(){
            waitTime += 500;

            if(locationReady){
                clearInterval(interval);
                openOSMMap();
            }

            if(waitTime >= 10000){
                clearInterval(interval);
                console.warn("GPS timeout - opening map anyway");
                openOSMMap();
            }

        }, 500);
    }
});
</script>

</body>
</html>
